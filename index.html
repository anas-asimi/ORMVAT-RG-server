<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .location-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            width: 50px;
            height: 50px;
            background-color: #2563eb;
            border: none;
            border-radius: 50%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .location-button:active {
            background-color: #1d4ed8;
        }

        .location-icon {
            width: 24px;
            height: 24px;
            fill: white;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <button class="location-button" onclick="locateUser()">
        <svg class="location-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z" />
        </svg>
    </button>

    <script>
        console.log('üó∫Ô∏è Initializing map...');
        const map = L.map('map').setView([32.294577425170004, -6.7027966781581165], 10);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);
        console.log('‚úÖ Map initialized');

        let userMarker = null;

        function locateUser() {
            console.log('üìç Location button clicked');
            // Send message to React Native to get location
            if (window.ReactNativeWebView) {
                console.log('üì§ Sending getLocation request to React Native');
                window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'getLocation' }));
            } else {
                console.log('‚ö†Ô∏è Not in React Native WebView, using browser geolocation');
                // Fallback for web testing
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            console.log('‚úÖ Browser location received:', position.coords);
                            updateUserLocation(position.coords.latitude, position.coords.longitude);
                        },
                        (error) => {
                            console.error('‚ùå Browser geolocation error:', error);
                            alert('Unable to get location: ' + error.message);
                        }
                    );
                } else {
                    console.error('‚ùå Geolocation not supported');
                }
            }
        }

        function updateUserLocation(lat, lon) {
            console.log('üìç Updating user location:', { lat, lon });
            
            // Remove old marker if exists
            if (userMarker) {
                console.log('üóëÔ∏è Removing old marker');
                map.removeLayer(userMarker);
            }

            // Add new marker
            userMarker = L.marker([lat, lon], {
                icon: L.divIcon({
                    className: 'user-location-marker',
                    html: '<div style="background-color: #2563eb; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5);"></div>',
                    iconSize: [22, 22],
                    iconAnchor: [11, 11]
                })
            }).addTo(map);

            userMarker.bindPopup('Your Location').openPopup();

            // Center map on user location
            map.setView([lat, lon], 15);
            console.log('‚úÖ User location updated and map centered');
        }

        // Listen for messages from React Native - document.addEventListener (for Android)
        document.addEventListener('message', (event) => {
            console.log('üì® Message received (document):', event.data);
            handleMessage(event.data);
        });

        // Listen for messages from React Native - window.addEventListener (for iOS)
        window.addEventListener('message', (event) => {
            console.log('üì® Message received (window):', event.data);
            handleMessage(event.data);
        });

        function handleMessage(data) {
            try {
                console.log('üîç Parsing message data...');
                const parsedData = typeof data === 'string' ? JSON.parse(data) : data;
                console.log('‚úÖ Parsed data:', parsedData);

                if (parsedData.type === 'locationUpdate') {
                    console.log('üìç Location update received:', parsedData);
                    updateUserLocation(parsedData.latitude, parsedData.longitude);
                } else if (parsedData.type === 'locationError') {
                    console.error('‚ùå Location error received:', parsedData.message);
                    alert('Location error: ' + parsedData.message);
                } else {
                    console.log('‚ö†Ô∏è Unknown message type:', parsedData.type);
                }
            } catch (error) {
                console.error('‚ùå Error parsing message:', error, 'Raw data:', data);
            }
        }

        console.log('üåê Loading GeoJSON layers...');

        // Add P GeoJSON layer
        fetch("https://anas-asimi.github.io/OrmvatRG-server/P.geojson")
            .then(response => response.json())
            .then(data => {
                L.geoJSON(data, {
                    style: function (feature) {
                        return {
                            weight: 1.5,
                            color: 'blue',
                        };
                    },
                }).addTo(map);
                console.log('‚úÖ P.geojson loaded');
            }).catch(error => console.error('‚ùå Error loading P.geojson:', error));

        // Add S GeoJSON layer
        fetch("https://anas-asimi.github.io/OrmvatRG-server/S.geojson")
            .then(response => response.json())
            .then(data => {
                L.geoJSON(data, {
                    style: function (feature) {
                        return {
                            weight: 1.5,
                            color: 'purple',
                        };
                    },
                }).addTo(map);
                console.log('‚úÖ S.geojson loaded');
            }).catch(error => console.error('‚ùå Error loading S.geojson:', error));

        // Add T GeoJSON layer
        fetch("https://anas-asimi.github.io/OrmvatRG-server/T.geojson")
            .then(response => response.json())
            .then(data => {
                L.geoJSON(data, {
                    style: function (feature) {
                        return {
                            weight: 1.5,
                            color: 'darkgreen',
                        };
                    },
                }).addTo(map);
                console.log('‚úÖ T.geojson loaded');
            }).catch(error => console.error('‚ùå Error loading T.geojson:', error));

        const ZOOM_THRESHOLD = 14;

        // Function to update the marker's visibility
        function updateMarkerVisibility() {
            console.log("üîç Zoom level changed");

            const currentZoom = map.getZoom();
            console.log("üîç Current Zoom Level:", currentZoom);

            const iconElements = document.getElementsByClassName('custom-annotation');
            for (let iconElement of iconElements) {
                if (iconElement) {
                    if (currentZoom < ZOOM_THRESHOLD) {
                        iconElement.style.visibility = 'hidden';
                    } else {
                        iconElement.style.visibility = 'visible';
                    }
                }
            }
        }

        // add points from annotations.json
        fetch("https://anas-asimi.github.io/OrmvatRG-server/annotations.json")
            .then(response => response.json())
            .then(data => {
                data.forEach(point => {
                    let myTextIcon = L.divIcon({
                        className: `${point.value}`,
                        html: `<div class="custom-annotation" style="transform: rotate(${point.angleInDegrees - 90}deg); transform-origin: center center;visibility: hidden;">${point.value}</div>`,
                        iconSize: [100, 20]
                    });
                    const marker = L.marker([point.lat, point.lon], { icon: myTextIcon }).addTo(map);
                });
                console.log('‚úÖ Annotations loaded');
            }).catch(error => console.error('‚ùå Error loading annotations:', error));

        // Attach the function to the 'zoomend' event
        map.on('zoomend', updateMarkerVisibility);

        console.log('‚úÖ All event listeners set up');
    </script>
</body>

</html>
